<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>David â€” Fake AI Assistant (PWA)</title>
  <meta name="description" content="David â€” a fake HTML AI that runs like an app. Face-scan, wake-word, weather, time, messages, notifications." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23348'/%3E%3Ctext x='50' y='58' font-size='40' text-anchor='middle' fill='white' font-family='Arial'%3ED%3C/text%3E%3C/svg%3E" />
  <style>
    :root{--bg:#0f1724;--card:#0b1320;--accent:#20a4f3;--muted:#9aa7b2;color-scheme:dark}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:linear-gradient(180deg,var(--bg),#071227);color:#e6eef6}
    .app{max-width:720px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px}
    h1{font-size:20px;margin:0}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .full{grid-column:1/-1}
    .card{background:rgba(255,255,255,0.03);padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.4)}
    button{background:var(--accent);border:none;color:#001724;padding:10px;border-radius:8px;font-weight:600}
    input,textarea,select{width:100%;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:inherit}
    small{color:var(--muted)}
    #video{width:100%;border-radius:8px;background:#000}
    .row{display:flex;gap:8px}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div style="width:52px;height:52px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#0a7fc0);display:flex;align-items:center;justify-content:center;font-weight:700">D</div>
      <div>
        <h1>David â€” Fake HTML Assistant</h1>
        <small>Installable PWA / uses camera & mic (consent required)</small>
      </div>
    </header><section class="grid">
  <div class="card full">
    <strong>Status:</strong> <span id="status">idle</span>
    <div style="margin-top:8px" id="accessBadges">ðŸ”’ Face scan: <span id="faceState">not scanned</span> â€¢ ðŸ”” Notifications: <span id="notifState">unknown</span></div>
  </div>

  <div class="card">
    <h3>Face Scan</h3>
    <video id="video" autoplay muted playsinline></video>
    <div style="margin-top:8px" class="row">
      <button id="btnStartFace">Start Face Scan</button>
      <button id="btnStopFace">Stop</button>
    </div>
    <small>Face scanning uses your camera. If your browser supports the Shape Detection API it will be faster; otherwise a JS fallback is used.</small>
  </div>

  <div class="card">
    <h3>Wake word (Speech)</h3>
    <div class="row">
      <button id="btnStartWake">Start Listening</button>
      <button id="btnStopWake">Stop</button>
    </div>
    <p><small>Say "David" to trigger the assistant (works while page is open and visible).</small></p>
    <div><strong>Last heard:</strong> <span id="lastHeard">â€”</span></div>
  </div>

  <div class="card">
    <h3>Time & Weather</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px"><button id="btnTime">Get Time</button><button id="btnWeather">Get Weather (by location)</button></div>
    <div id="timeWeather"></div>
  </div>

  <div class="card">
    <h3>Calls & Open App</h3>
    <input id="phone" placeholder="Phone number (e.g. +2781...)">
    <div class="row" style="margin-top:8px"><button id="btnCall">Call (tel:)</button><button id="btnDial">Open Dialer</button></div>
    <hr/>
    <input id="appScheme" placeholder="App URL or intent (e.g. whatsapp://, com.whatsapp)">
    <div class="row" style="margin-top:8px"><button id="btnOpenApp">Open App</button><button id="btnIntent">Open Android Intent</button></div>
    <small>Opening other apps depends on the device and whether the app supports URL schemes or Android intents.</small>
  </div>

  <div class="card">
    <h3>Messages (persisted)</h3>
    <textarea id="newMsg" rows="3" placeholder="Type message for David to store"></textarea>
    <div class="row" style="margin-top:8px"><button id="btnSaveMsg">Save Message</button><button id="btnShowMsgs">Show Messages</button></div>
    <div id="msgs" style="margin-top:8px;white-space:pre-wrap"></div>
  </div>

  <div class="card full">
    <h3>Notifications</h3>
    <div class="row"><button id="btnRequestNotif">Enable Notifications</button><button id="btnNotif">Send "Talk to Me"</button></div>
    <small>Grant permission when prompted. Notifications only fire while the site is open unless a Service Worker is active (this file registers one).</small>
  </div>

  <div class="card full">
    <h3>Advanced & Developer</h3>
    <label>OpenWeatherMap API Key (required for weather):</label>
    <input id="owmKey" placeholder="YOUR_OPENWEATHERMAP_API_KEY">
    <div style="margin-top:8px" class="row"><button id="btnInstall">Install PWA</button><button id="btnClear">Clear Stored Messages</button></div>
    <small>Tip: Add this page to your home screen (Install) to behave like an app.</small>
  </div>
</section>

<footer>Made for testing & demo. This is a fake assistant â€” it will not access your phone outside the browser. Use with consent.</footer>

  </div>  <script>
    // Simple state & helpers
    const statusEl = document.getElementById('status');
    const faceState = document.getElementById('faceState');
    const notifState = document.getElementById('notifState');
    const video = document.getElementById('video');

    const setStatus = s => statusEl.textContent = s;
    const setFace = s => faceState.textContent = s;
    const setNotif = s => notifState.textContent = s;

    let localStream = null;
    let faceDetector = null;
    let faceInterval = null;

    // --- PWA install prompt handling ---
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('PWA install available');
    });

    document.getElementById('btnInstall').addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const choice = await deferredPrompt.userChoice;
        deferredPrompt = null;
        alert('Install choice: ' + choice.outcome);
      } else alert('Install not available â€” open this page in Chrome and use Add to Home screen.');
    });

    // --- Notifications ---
    document.getElementById('btnRequestNotif').addEventListener('click', async () => {
      if (!('Notification' in window)) return alert('Notifications not supported');
      const perm = await Notification.requestPermission();
      setNotif(perm);
      alert('Notification permission: ' + perm);
    });
    document.getElementById('btnNotif').addEventListener('click', () => {
      sendTalkToMe();
    });

    function sendTalkToMe(){
      if (Notification.permission !== 'granted') return alert('Notifications not granted');
      const n = new Notification('David', {body: 'Talk to Me', tag: 'david-talk'});
      n.onclick = () => window.focus();
    }

    // --- Face scanning using Shape Detection API with fallback to face-api.js ---
    async function startFaceScan(){
      setStatus('starting camera...');
      try {
        localStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:false});
        video.srcObject = localStream;
        setStatus('camera started');

        if ('FaceDetector' in window){
          faceDetector = new FaceDetector({fastMode:true});
          setStatus('using built-in FaceDetector');
          faceInterval = setInterval(async () => {
            try{
              const tracks = localStream.getVideoTracks();
              if (!tracks || tracks.length===0) return;
              const frame = await faceDetector.detect(video);
              if (frame && frame.length>0){
                setFace('face detected â€” access approved');
                setStatus('face detected');
                // we stop auto-scanning after first success
                // keep camera open for other operations if you want
                clearInterval(faceInterval);
              } else {
                setFace('no face');
                setStatus('scanning...');
              }
            }catch(e){console.warn(e)}
          }, 900);
        } else {
          setStatus('FaceDetector not supported; loading fallback');
          await loadScript('https://cdn.jsdelivr.net/npm/face-api.js');
          await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/weights');
          setStatus('face-api loaded');
          faceInterval = setInterval(async () => {
            const detections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
            if (detections && detections.length>0){
              setFace('face detected â€” access approved (fallback)');
              setStatus('face detected');
              clearInterval(faceInterval);
            } else {
              setFace('no face (fallback)');
              setStatus('scanning (fallback)');
            }
          }, 900);
        }
      } catch(err){
        console.error(err);
        alert('Camera access denied or error: ' + err.message);
        setStatus('camera error');
      }
    }
    function stopFaceScan(){
      if (faceInterval) clearInterval(faceInterval);
      if (localStream){
        localStream.getTracks().forEach(t=>t.stop());
        localStream = null;
      }
      video.srcObject = null;
      setStatus('stopped');
    }
    document.getElementById('btnStartFace').addEventListener('click', startFaceScan);
    document.getElementById('btnStopFace').addEventListener('click', stopFaceScan);

    function loadScript(src){
      return new Promise((res,rej)=>{
        const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s);
      })
    }

    // --- Wake-word using Web Speech API (SpeechRecognition) ---
    const lastHeard = document.getElementById('lastHeard');
    let recognition=null;
    function startWake(){
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){
        alert('SpeechRecognition not supported in this browser. Use Chrome on Android for best results.');
        return;
      }
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = false;
      recognition.lang = 'en-US';

      recognition.onresult = (ev) => {
        const transcript = ev.results[ev.results.length -1][0].transcript.trim();
        lastHeard.textContent = transcript;
        if (/\bdavid\b/i.test(transcript)){
          onWakeTriggered();
        }
      };
      recognition.onerror = (e)=>console.warn('Speech error', e);
      recognition.onend = ()=>{ console.log('Recognition ended'); }
      recognition.start();
      setStatus('listening for wake word');
    }
    function stopWake(){ if (recognition) {recognition.stop(); recognition=null; setStatus('idle');} }
    document.getElementById('btnStartWake').addEventListener('click', startWake);
    document.getElementById('btnStopWake').addEventListener('click', stopWake);

    function onWakeTriggered(){
      setStatus('wake word detected â€” awaiting command');
      // simple voice reply via speechSynthesis
      const utter = new SpeechSynthesisUtterance('Hello sir. Would you like me to enable microphone and notifications?');
      speechSynthesis.speak(utter);
      // also show a notification if possible
      if (Notification.permission === 'granted') sendTalkToMe();
    }

    // --- Time & Weather (uses Geolocation + OpenWeatherMap) ---
    document.getElementById('btnTime').addEventListener('click', () => {
      const now = new Date();
      document.getElementById('timeWeather').textContent = 'Local time: ' + now.toString();
    });

    document.getElementById('btnWeather').addEventListener('click', async () => {
      const key = document.getElementById('owmKey').value.trim();
      if (!key) return alert('Please provide OpenWeatherMap API key in Advanced section');
      if (!('geolocation' in navigator)) return alert('Geolocation not supported');
      setStatus('getting location...');
      navigator.geolocation.getCurrentPosition(async pos => {
        setStatus('fetching weather...');
        const lat = pos.coords.latitude; const lon = pos.coords.longitude;
        try{
          const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&appid=${key}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error('Weather fetch failed');
          const data = await res.json();
          document.getElementById('timeWeather').textContent = `Weather at (${lat.toFixed(3)},${lon.toFixed(3)}): ${data.weather[0].description}, ${data.main.temp}Â°C`;
          setStatus('weather ready');
        }catch(e){
          alert('Weather error: ' + e.message);
          setStatus('weather error');
        }
      }, err=>{alert('Location error: ' + err.message); setStatus('location error')});
    });

    // --- Calls & open app ---
    document.getElementById('btnCall').addEventListener('click', () => {
      const num = document.getElementById('phone').value.trim();
      if (!num) return alert('Enter phone number');
      // attempt to call via tel: (will open dialer or start call depending on user agent)
      window.location.href = 'tel:' + encodeURIComponent(num);
    });
    document.getElementById('btnDial').addEventListener('click', () => {
      const num = document.getElementById('phone').value.trim();
      if (!num) return alert('Enter phone number');
      window.open('tel:' + encodeURIComponent(num), '_self');
    });

    document.getElementById('btnOpenApp').addEventListener('click', () => {
      const u = document.getElementById('appScheme').value.trim();
      if (!u) return alert('Enter an app scheme or URL');
      // try to open as URL scheme
      window.location.href = u;
    });
    document.getElementById('btnIntent').addEventListener('click', () => {
      const pkg = document.getElementById('appScheme').value.trim();
      if (!pkg) return alert('Enter package name (e.g. com.whatsapp)');
      // Android intent URL (works on Chrome on Android when supported)
      const intentUrl = `intent://#Intent;package=${pkg};end`;
      window.location.href = intentUrl;
    });

    // --- Messages persistence ---
    const STORAGE_KEY = 'david_messages_v1';
    function loadMessages(){
      try{const j = localStorage.getItem(STORAGE_KEY); return j?JSON.parse(j):[];}catch(e){return []}
    }
    function saveMessages(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
    function refreshMessages(){
      const arr = loadMessages();
      document.getElementById('msgs').textContent = arr.length?arr.map((m,i)=>`${i+1}. ${m}`).join('\n'):'(no messages)';
    }
    document.getElementById('btnSaveMsg').addEventListener('click', ()=>{
      const t = document.getElementById('newMsg').value.trim(); if (!t) return alert('Type a message');
      const arr = loadMessages(); arr.unshift(t); saveMessages(arr); document.getElementById('newMsg').value=''; refreshMessages();
      alert('Message saved');
    });
    document.getElementById('btnShowMsgs').addEventListener('click', refreshMessages);
    document.getElementById('btnClear').addEventListener('click', ()=>{ if(confirm('Clear saved messages?')){ localStorage.removeItem(STORAGE_KEY); refreshMessages(); } });
    refreshMessages();

    // --- Service worker registration (simple) ---
    if ('serviceWorker' in navigator){
      // Register a small service worker created from a blob so we keep single-file distribution
      const swCode = `self.addEventListener('install',e=>self.skipWaiting());self.addEventListener('activate',e=>self.clients.claim());self.addEventListener('fetch',e=>{});
      self.addEventListener('notificationclick', function(event){ event.notification.close(); event.waitUntil(clients.openWindow('/')); });`;
      const blob = new Blob([swCode],{type:'application/javascript'});
      const url = URL.createObjectURL(blob);
      navigator.serviceWorker.register(url).then(()=>console.log('SW registered (blob)')).catch(e=>console.warn('SW reg fail',e));
    }

    // --- Installable manifest via blob (keeps everything in one file) ---
    (function registerManifest(){
      const manifest = {
        name: 'David â€” Fake Assistant',
        short_name: 'David',
        start_url: '.',
        display: 'standalone',
        background_color: '#071227',
        theme_color: '#0a7fc0',
        icons: [{src:document.querySelector('link[rel=icon]').href,sizes:'192x192',type:'image/svg+xml'}]
      };
      const blob = new Blob([JSON.stringify(manifest)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const link = document.createElement('link'); link.rel='manifest'; link.href=url; document.head.appendChild(link);
    })();

    // --- On load, set basic states ---
    (function init(){
      setNotif(Notification.permission);
      setFace('not scanned');
      setStatus('idle');
    })();

  </script></body>
</html>
