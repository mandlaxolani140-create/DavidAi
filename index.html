<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cemza the Goat ‚Äî Personal AI</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#7c3aed;--muted:#94a3b8;--glass: rgba(255,255,255,0.03)}
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#001022 0%,#07112a 100%);color:#e6eef8;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px}
    .wrap{width:100%;max-width:920px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(2,6,23,.6)}
    header{display:flex;align-items:center;gap:14px;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.03);margin-bottom:12px}
    h1{font-size:1.25rem;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:0.95rem}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    button, input[type="range"],label{background:var(--card);color:#e8f0ff;border:0;padding:10px 12px;border-radius:10px}
    button:hover{transform:translateY(-1px);cursor:pointer}
    .big{font-weight:600;padding:12px 16px}
    .row{display:flex;gap:8px}
    .grow{flex:1}
    .io{display:flex;gap:8px;margin-top:12px;align-items:center}
    textarea{width:100%;min-height:60px;padding:10px;border-radius:10px;background:transparent;color:inherit;border:1px solid rgba(255,255,255,0.04)}
    .songs{margin-top:12px;border-radius:10px;padding:10px;background:var(--glass);color:var(--muted);font-size:0.95rem}
    .song-item{display:flex;align-items:center;justify-content:space-between;padding:6px 8px;border-radius:8px;margin-top:8px;background:rgba(255,255,255,0.01)}
    .footer{margin-top:14px;color:var(--muted);font-size:0.85rem}
    .hint{font-size:0.86rem;color:var(--muted)}
    .hidden{display:none}
    @media (max-width:640px){header{flex-direction:column;align-items:flex-start} .row{flex-direction:column}}
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <header>
      <div>
        <h1>Cemza the Goat ‚Äî Personal Assistant</h1>
        <p class="lead">Speak or type commands. Examples: <em>Who are you?</em> ‚Äî <em>Play I never forget</em></p>
      </div>
    </header>

    <div class="controls" aria-hidden="false">
      <div class="row">
        <button id="speakBtn" class="big">üé§ Speak</button>
        <button id="stopBtn" class="big">‚èπÔ∏è Stop</button>
        <button id="requestMic" title="Ask browser for mic permission">Request Microphone Permission</button>
        <button id="ttsTest">TTS Test</button>
      </div>
      <div class="row io" style="margin-top:8px">
        <textarea id="textInput" placeholder="Type a command (e.g. Who are you ‚Äî Play I never forget)"></textarea>
        <div style="display:flex;flex-direction:column;gap:8px;min-width:140px">
          <button id="sendBtn">Send</button>
          <label style="display:block">
            Volume <input id="volume" type="range" min="0" max="1" step="0.05" value="1">
          </label>
        </div>
      </div>
    </div>

    <div style="margin-top:12px">
      <label class="hint">Upload songs (select multiple)</label><br/>
      <input id="fileInput" type="file" accept="audio/*" multiple />
      <div id="songsContainer" class="songs" aria-live="polite">
        <div id="emptyLabel">No songs uploaded yet.</div>
        <div id="list"></div>
      </div>
    </div>

    <div class="footer">
      <div>If a song isn't available locally the assistant will open Facebook search for "Cemza the goat" (or YouTube as fallback).</div>
      <div class="hint" style="margin-top:6px">Tip: add this page to Home screen in Chrome for app-like behavior. The browser will prompt for microphone permission when you use Speak.</div>
    </div>
  </main>

<script>
/* Cemza Personal Assistant ‚Äî Single-file client-side implementation
   Notes:
   - Uses Web Speech API (SpeechRecognition) for voice input.
   - Uses speechSynthesis for TTS.
   - Local audio files are stored in memory (File objects) and shown in a list.
   - Search fallback opens Facebook search or YouTube for the requested song name.
*/

/* Feature detection */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const hasRec = !!SpeechRecognition;
const speakBtn = document.getElementById('speakBtn');
const stopBtn = document.getElementById('stopBtn');
const requestMic = document.getElementById('requestMic');
const ttsTest = document.getElementById('ttsTest');
const sendBtn = document.getElementById('sendBtn');
const textInput = document.getElementById('textInput');
const fileInput = document.getElementById('fileInput');
const listEl = document.getElementById('list');
const emptyLabel = document.getElementById('emptyLabel');
const volumeSlider = document.getElementById('volume');

let recognition = null;
let recognizing = false;
let localSongs = []; // {name, file, url, audioEl}
let currentAudio = null;

function initRecognition() {
  if(!hasRec) {
    speakBtn.disabled = true;
    stopBtn.disabled = true;
    requestMic.disabled = false;
    requestMic.textContent = "Microphone not supported";
    return;
  }
  recognition = new SpeechRecognition();
  recognition.lang = 'en-GB';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => {
    recognizing = true;
    speakBtn.textContent = 'Listening...';
  };
  recognition.onend = () => {
    recognizing = false;
    speakBtn.textContent = 'üé§ Speak';
  };
  recognition.onerror = (e) => {
    console.error('Recognition error', e);
    recognizing = false;
    speakBtn.textContent = 'üé§ Speak';
  };
  recognition.onresult = (evt) => {
    const text = evt.results[0][0].transcript;
    console.log('Heard:', text);
    textInput.value = text;
    handleCommand(text);
  };
}

/* Start/Stop */
speakBtn.addEventListener('click', () => {
  if(!recognition) initRecognition();
  if(!recognition) { alert('Speech Recognition not supported in this browser.'); return; }
  if(recognizing) {
    recognition.stop();
    return;
  }
  try {
    recognition.start();
  } catch (err) {
    console.warn('Start error', err);
  }
});

stopBtn.addEventListener('click', () => {
  if(recognition && recognizing) recognition.stop();
  if(currentAudio) { currentAudio.pause(); currentAudio.currentTime = 0; }
});

/* Request mic permission (prompt) */
requestMic.addEventListener('click', async () => {
  try {
    await navigator.mediaDevices.getUserMedia({ audio: true });
    alert('Microphone permission granted (or prompt shown).');
  } catch (err) {
    alert('Microphone permission denied or error: ' + (err.message || err));
  }
});

/* TTS test */
ttsTest.addEventListener('click', () => speakText("Hello sir, I am Cemza the Goat ‚Äî your personal assistant. Say a command or type one."));

/* Send typed text */
sendBtn.addEventListener('click', () => {
  const txt = textInput.value.trim();
  if(!txt) return;
  handleCommand(txt);
});

/* Volume control: adjust speechSynthesis and audio elements */
volumeSlider.addEventListener('input', () => {
  const v = parseFloat(volumeSlider.value);
  if(currentAudio) currentAudio.volume = v;
});

/* File handling */
fileInput.addEventListener('change', (e) => {
  const files = Array.from(e.target.files);
  for (const f of files) {
    const url = URL.createObjectURL(f);
    const name = f.name;
    const audioEl = new Audio(url);
    audioEl.preload = 'metadata';
    audioEl.volume = parseFloat(volumeSlider.value);
    localSongs.push({name, file: f, url, audioEl});
  }
  renderSongList();
});

function renderSongList(){
  listEl.innerHTML = '';
  if(localSongs.length === 0) {
    emptyLabel.style.display = 'block';
    return;
  }
  emptyLabel.style.display = 'none';
  localSongs.forEach((s, idx) => {
    const item = document.createElement('div');
    item.className = 'song-item';
    item.innerHTML = \`
      <div style="display:flex;gap:10px;align-items:center">
        <div>\${s.name}</div>
        <div style="font-size:0.8rem;color:var(--muted)">(\${Math.round((s.file.size/1024)/1024*100)/100} MB)</div>
      </div>
      <div style="display:flex;gap:6px">
        <button data-idx="\${idx}" class="play">Play</button>
        <button data-idx="\${idx}" class="stop">Stop</button>
        <button data-idx="\${idx}" class="remove">Remove</button>
      </div>
    \`;
    listEl.appendChild(item);
  });

  listEl.querySelectorAll('.play').forEach(btn => btn.onclick = (ev) => {
    const i = +ev.target.dataset.idx;
    playLocal(i);
  });
  listEl.querySelectorAll('.stop').forEach(btn => btn.onclick = (ev) => {
    const i = +ev.target.dataset.idx;
    stopLocal(i);
  });
  listEl.querySelectorAll('.remove').forEach(btn => btn.onclick = (ev) => {
    const i = +ev.target.dataset.idx;
    removeLocal(i);
  });
}

function playLocal(index) {
  stopCurrentAudio();
  const item = localSongs[index];
  if(!item) return;
  currentAudio = item.audioEl;
  currentAudio.volume = parseFloat(volumeSlider.value);
  currentAudio.play().catch(e => console.warn('play error', e));
}

function stopLocal(index) {
  const item = localSongs[index];
  if(!item) return;
  item.audioEl.pause();
  item.audioEl.currentTime = 0;
  if(currentAudio === item.audioEl) currentAudio = null;
}

function stopCurrentAudio() {
  if(currentAudio) {
    try { currentAudio.pause(); currentAudio.currentTime = 0; } catch(e){}
    currentAudio = null;
  }
}

function removeLocal(index) {
  const item = localSongs[index];
  if(!item) return;
  try { URL.revokeObjectURL(item.url); } catch(e){}
  localSongs.splice(index,1);
  renderSongList();
}

/* Command handling */
function handleCommand(text) {
  const lower = text.toLowerCase();
  // Basic identity responses
  if(lower.includes('who are you') || lower.includes('what is your name')) {
    speakText("I am Cemza the Goat, your personal assistant. I can listen, talk, and play your songs.");
    return;
  }

  // Play song request patterns: "play <song name>"
  const playMatch = lower.match(/play\\s+(.+)/);
  if(playMatch) {
    const songName = playMatch[1].trim();
    // Try to find local song by filename or partial match
    const found = localSongs.find(s => s.name.toLowerCase().includes(songName) || s.name.toLowerCase().replace(/[-_]/g,' ').includes(songName));
    if(found) {
      speakText('Playing ' + found.name);
      // play the found song
      stopCurrentAudio();
      currentAudio = found.audioEl;
      currentAudio.volume = parseFloat(volumeSlider.value);
      currentAudio.play().catch(e => {
        console.warn('Play failed', e);
        speakText('I could not play the song locally. I will search for it online.');
        openSearchFallback(songName);
      });
      return;
    } else {
      speakText('I could not find "' + songName + '" locally. Searching on Facebook and YouTube.');
      openSearchFallback(songName);
      return;
    }
  }

  // Stop playback
  if(lower === 'stop' || lower === 'pause' || lower === 'stop playback') {
    stopCurrentAudio();
    speakText('Stopped.');
    return;
  }

  // If the user asks to "open settings" or similar - limited in web
  if(lower.includes('settings') || lower.includes('audio settings')) {
    speakText('I cannot change your phone settings from a web page, but you can control volume here or upload songs for local playback.');
    return;
  }

  // Unknown: respond and offer help
  speakText("Sorry, I didn't understand that fully. Try: 'Play <song name>' or 'Who are you?'");
}

/* Open fallback search (Facebook then YouTube) */
function openSearchFallback(query) {
  const fb = 'https://m.facebook.com/search/top/?q=' + encodeURIComponent(query + ' Cemza the goat');
  const yt = 'https://www.youtube.com/results?search_query=' + encodeURIComponent(query + ' Cemza the goat');
  // try to open FB first
  window.open(fb, '_blank');
  // open YouTube with slight delay to avoid popup blocks in some browsers
  setTimeout(()=>window.open(yt, '_blank'), 300);
}

/* TTS helper */
function speakText(text) {
  if('speechSynthesis' in window) {
    const utter = new SpeechSynthesisUtterance(text);
    utter.volume = parseFloat(volumeSlider.value) || 1;
    // choose a voice if available (prefer a language match)
    const voices = speechSynthesis.getVoices();
    if(voices && voices.length) {
      // prefer english voices
      const v = voices.find(v=>v.lang.toLowerCase().startsWith('en')) || voices[0];
      if(v) utter.voice = v;
    }
    speechSynthesis.cancel();
    speechSynthesis.speak(utter);
  } else {
    console.log('TTS:', text);
    alert(text);
  }
}

/* Init on load */
(function init(){
  if(!hasRec) {
    console.warn('SpeechRecognition not supported in this browser.');
    // show hint
  } else {
    initRecognition();
  }
  renderSongList();
})();
</script>
</body>
</html>
