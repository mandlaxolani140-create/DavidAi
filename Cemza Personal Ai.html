<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cemza the Goat ‚Äî Personal AI</title>
<style>
  :root{--bg:#0b0b0b;--card:#121212;--accent:#1DB954;--muted:#9aa0a6;color-scheme:dark}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:#fff;margin:0;display:flex;align-items:center;justify-content:center;height:100vh;padding:18px}
  .app{width:100%;max-width:720px;background:linear-gradient(180deg,#0f0f0f, #0b0b0b);border-radius:14px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,.6)}
  h1{margin:0 0 8px;font-size:20px}
  p.small{color:var(--muted);margin:0 0 12px;font-size:13px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
  button, input[type="file"]{background:var(--card);color:#fff;border:0;padding:10px 14px;border-radius:10px;font-size:15px}
  button.primary{background:var(--accent);font-weight:600}
  input[type="range"]{width:100%}
  .log{background:#080808;border-radius:10px;padding:10px;height:160px;overflow:auto;font-size:14px;color:#ddd}
  .controls{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
  .files-list{font-size:14px;color:var(--muted);margin-top:8px}
  .hint{font-size:12px;color:var(--muted);margin-top:6px}
  footer{font-size:12px;color:var(--muted);margin-top:10px;text-align:center}
  a{color:var(--accent)}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Cemza the Goat personal assistant">
    <h1>Cemza the Goat ‚Äî Personal Assistant</h1>
    <p class="small">Speak or type commands. Example: <em>Who are you?</em> ‚Äî <em>Play I never forget</em></p>

    <div class="row">
      <button id="btn-speak" class="primary">üé§ Speak</button>
      <button id="btn-stop">‚èπÔ∏è Stop</button>
      <button id="btn-perm">üîê Request Microphone Permission</button>
      <button id="btn-tts-test">üîà TTS Test</button>
    </div>

    <div class="row">
      <input id="text-cmd" placeholder="Type a command here (e.g. play missing you)" style="flex:1;padding:10px;border-radius:10px;border:0;background:#0a0a0a;color:#fff">
      <button id="btn-send">Send</button>
    </div>

    <div class="controls">
      <label style="display:block">Volume<br><input id="volume" type="range" min="0" max="1" step="0.01" value="0.9"></label>
      <label style="display:block">Upload songs (select multiple)<br><input id="file-picker" type="file" accept="audio/*" multiple></label>
    </div>

    <div class="row">
      <div style="flex:1">
        <div class="log" id="log" aria-live="polite"></div>
        <div class="hint">If a song isn't available locally the assistant will open Facebook search for "Cemza the goat".</div>
      </div>
    </div>

    <div class="files-list" id="files-list">No songs uploaded yet.</div>

    <footer>
      Tip: add this page to Home screen in Chrome for app-like behavior. The browser will prompt for microphone permission when you use Speak.
    </footer>
  </div>

<script>
/* Cemza AI ‚Äî single-file web assistant
   Uses Web Speech API for recognition and speechSynthesis for TTS.
   Local songs are stored in memory via File objects from the file picker.
*/

const logEl = document.getElementById('log');
const filesListEl = document.getElementById('files-list');
const btnSpeak = document.getElementById('btn-speak');
const btnStop = document.getElementById('btn-stop');
const btnPerm = document.getElementById('btn-perm');
const btnTtsTest = document.getElementById('btn-tts-test');
const textCmd = document.getElementById('text-cmd');
const btnSend = document.getElementById('btn-send');
const filePicker = document.getElementById('file-picker');
const volumeControl = document.getElementById('volume');

let audioEl = new Audio();
audioEl.crossOrigin = "anonymous";
audioEl.volume = parseFloat(volumeControl.value);

volumeControl.addEventListener('input', () => {
  audioEl.volume = parseFloat(volumeControl.value);
  speak(`Volume set to ${Math.round(audioEl.volume * 100)} percent`);
  log(`Volume set to ${Math.round(audioEl.volume * 100)}%`);
});

// song library: map normalized title -> File object
const songLibrary = new Map();

// normalize string helper
function norm(s){ return (s||'').toString().toLowerCase().trim().replace(/[^\w\s']/g,''); }

function log(msg){
  const t = new Date().toLocaleTimeString();
  logEl.innerHTML = `<div>[${t}] ${escapeHtml(msg)}</div>` + logEl.innerHTML;
}

function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }

// TTS
function speak(text){
  if (!text) return;
  console.log("TTS:", text);
  log(`AI: ${text}`);
  // prefer speechSynthesis
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-GB';
  u.rate = 1;
  window.speechSynthesis.cancel(); // stop previous
  window.speechSynthesis.speak(u);
}

// Recognizer wrapper (webkitSpeechRecognition commonly supported)
let recognizer = null;
let recognizing = false;
function initRecognizer(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    log("Speech recognition not supported in this browser.");
    return null;
  }
  recognizer = new SpeechRecognition();
  recognizer.lang = 'en-GB';
  recognizer.interimResults = false;
  recognizer.maxAlternatives = 1;
  recognizer.onresult = (e) => {
    const text = e.results[0][0].transcript;
    log(`You (voice): ${text}`);
    processCommand(text);
  };
  recognizer.onerror = (ev) => {
    log("Recognition error: " + ev.error);
  };
  recognizer.onend = () => {
    recognizing = false;
    btnSpeak.disabled = false;
    log("Voice input ended.");
  };
  return recognizer;
}

btnPerm.addEventListener('click', async () => {
  // trigger microphone permission prompt by requesting getUserMedia
  try {
    await navigator.mediaDevices.getUserMedia({ audio: true });
    log("Microphone permission granted.");
    speak("Microphone permission granted.");
  } catch (err) {
    log("Microphone permission denied or blocked.");
    alert("Please allow microphone permission in Chrome site settings.");
  }
});

btnTtsTest.addEventListener('click', () => {
  speak("Cemza the goat personal assistant ready.");
});

btnSpeak.addEventListener('click', () => {
  if (!recognizer) initRecognizer();
  if (!recognizer) { alert("Speech recognition not supported in this browser."); return; }
  try {
    recognizer.start();
    recognizing = true;
    btnSpeak.disabled = true;
    log("Listening...");
  } catch (e) {
    log("Could not start recognizer: " + e);
  }
});

btnStop.addEventListener('click', () => {
  if (recognizer && recognizing) recognizer.stop();
  if (!audioEl.paused) {
    audioEl.pause();
    audioEl.currentTime = 0;
  }
  window.speechSynthesis.cancel();
  log("Playback and recognition stopped.");
});

btnSend.addEventListener('click', () => {
  const txt = textCmd.value.trim();
  if (!txt) return;
  log(`You: ${txt}`);
  processCommand(txt);
  textCmd.value = '';
});

filePicker.addEventListener('change', (ev) => {
  const files = Array.from(ev.target.files || []);
  if (!files.length) return;
  let added = [];
  files.forEach(f => {
    // try to map by filename keywords ‚Äî common titles you provided
    const name = norm(f.name.replace(/\.[^/.]+$/, "")); // remove ext
    // store by filename, and by known canonical names if they appear in filename
    songLibrary.set(name, f);
    // also try canonical mapping for common titles
    const canonical = matchCanonicalTitle(name);
    if (canonical) songLibrary.set(canonical, f);
    added.push(f.name);
  });
  filesListEl.textContent = `Uploaded: ${added.join(', ')}`;
  log(`Uploaded files: ${added.join(', ')}`);
});

// canonical titles user requested (normalized)
const canonTitles = [
  "i never forget",
  "come back",
  "raining in your eyes",
  "missing you",
  "i'm your batman",
  "im your batman",
  "used to be on my mind",
  "driving at night",
  "part 1",
  "part1",
  "swimming in heaven"
];

function matchCanonicalTitle(name){
  // return the canonical title if any canonical appears inside filename
  for (const t of canonTitles){
    if (name.includes(norm(t).replace(/'/g,''))) return norm(t).replace(/'+/g,"");
  }
  return null;
}

// process commands
function processCommand(raw){
  const text = (raw || '').toString().toLowerCase().trim();
  if (!text) return;
  // direct Q/A
  if (text.startsWith("who are you") || text.includes("who are you")) {
    speak("Cemza the goat personal assistant at your service.");
    return;
  }
  if (text.startsWith("who is cemza") || text.includes("who is cemza the goat")) {
    speak("He is a music artist who created me to assist you play his music.");
    return;
  }
  if (text.startsWith("what is his music") || text.includes("what is his songs") || text.includes("what is his music")) {
    speak("Songs like: I Never Forget, Come Back, Raining In Your Eyes, Missing You, I'm Your Batman, Used To Be On My Mind, Driving At Night, Part One, and Swimming In Heaven.");
    return;
  }

  if (text.startsWith("play ")) {
    const requested = text.replace(/^play\s+/,'').trim();
    handlePlay(requested);
    return;
  }

  if (text.startsWith("set volume to ") || text.startsWith("volume ")) {
    // parse percent or 0-1
    const m = text.match(/(\d{1,3})/);
    if (m) {
      let v = parseInt(m[1],10);
      if (v > 100) v = 100;
      audioEl.volume = v/100;
      volumeControl.value = audioEl.volume;
      speak(`Volume set to ${v} percent`);
      log(`Volume set to ${v}%`);
      return;
    }
  }

  if (text.includes("permission") || text.includes("enable")) {
    speak("Use the request microphone permission button and allow microphone and site permissions in Chrome's settings.");
    return;
  }

  // greetings
  if (text.includes("hello") || text.includes("hi")) {
    speak("Hello! I am Cemza the goat personal assistant. How can I help?");
    return;
  }

  // fallback
  speak("I did not understand exactly. Try: Play I never forget, or ask who Cemza the goat is.");
}

function handlePlay(requested){
  const rqNorm = norm(requested).replace(/'+/g,"");
  speak(`playing ${requested}, enjoy`);
  log(`Requested song: ${requested}`);

  // check library exact match or contains
  // try exact
  if (songLibrary.has(rqNorm)) {
    playFile(songLibrary.get(rqNorm));
    return;
  }
  // try contains match
  for (const [k,f] of songLibrary.entries()){
    if (k.includes(rqNorm) || rqNorm.includes(k)) {
      playFile(f);
      return;
    }
    // also check canonical titles
    for (const ct of canonTitles){
      if (k.includes(norm(ct)) && rqNorm.includes(norm(ct))) {
        playFile(f);
        return;
      }
    }
  }
  // last attempt: partial words search
  const words = rqNorm.split(/\s+/).filter(Boolean);
  if (words.length) {
    for (const [k,f] of songLibrary.entries()){
      const matches = words.every(w => k.includes(w) || k.includes(w.replace(/'/g,'')));
      if (matches) { playFile(f); return; }
    }
  }

  // not found: open Facebook search
  speak("I couldn't find the song locally. Opening Facebook search for Cemza the goat.");
  openFacebookSearch();
}

function playFile(file){
  if (!file) { openFacebookSearch(); return; }
  // create object URL and play
  const url = URL.createObjectURL(file);
  audioEl.src = url;
  audioEl.play().then(()=> {
    log(`Playing ${file.name}`);
  }).catch(err => {
    log('Playback error: ' + err);
    openFacebookSearch();
  });
  // revoke URL when finished
  audioEl.onended = () => {
    URL.revokeObjectURL(url);
    log('Playback ended.');
  };
}

function openFacebookSearch(){
  const fb = 'https://www.facebook.com/search/top?q=Cemza%20the%20goat';
  window.open(fb, '_blank');
  log('Opened Facebook search for Cemza the goat.');
}

/* Optional: prefill library via drag-and-drop or pre-known files - not possible from web without user action */

// Auto-init speechSynthesis voices (warm up)
if ('speechSynthesis' in window) {
  window.speechSynthesis.getVoices(); // warm
} else {
  log("TTS not supported on this browser.");
}

// init recognizer immediately if possible so permissions may be requested later
initRecognizer();

log("Cemza the goat assistant ready. Use Speak or type a command.");
</script>
</body>
</html>